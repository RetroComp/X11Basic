# Makefile for X11-Basic (c) Markus Hoffmann V.@version@
# Version 08.08.2007 modified by Markus Hoffmann

# Insert the defs for your machine

SHELL=/bin/sh

# Directories
prefix=@prefix@
exec_prefix=@exec_prefix@

BINDIR=@bindir@
DATADIR=@datadir@
LIBDIR=@libdir@
MANDIR=@mandir@

LIBNO=@version@

# Register variables (-ffixed-reg)
REGS= @regs@

# Optimization and debugging options
OPT=@copt@

# Additional header file paths
INC=@X_CFLAGS@ -I/usr/include/tine -I/usr/include/doocs -I.

# X11 library path
XLIBS=@X_LIBS@
VGA_LIBS= -lvgagl -lvga 
SFLAGS=

#Linux SVGALIB support :
#XLIBS=@X_LIBS@ -lvgagl -lvga 
#SFLAGS=-DUSE_SVGALIB

DEF= @def@ 

# Compiler
#CC=@CC@ @static@ $(REGS)
CC=@CC@ $(REGS)

# Cross-Compiler fuer Windows-Excecutable

# WINCC=i386-mingw32msvc-gcc
WINCC=i586-mingw32msvc-gcc

# Cross-Compiler fuer ARM-Linux-Excecutable

ARMCC=arm-linux-gcc

# Preprocessor
CPP=@CPP@

CFLAGS= $(INC) $(DEF) $(OPT) $(SFLAGS)


OBJS=   xbasic.o file.o ccs.o io.o parser.o variablen.o array.o\
        runtime.o wort_sep.o ltext.o functions.o\
	kommandos.o gkommandos.o do_gets.o errortxt.o window.o\
	sysVstuff.o

DISTOBJS=$(OBJS) main.o mathemat_dummy.o
LIBOBJS= $(OBJS) mathematics.o
WINLIBOBJS= $(OBJS) mathematics.o Windows.extension/fnmatch.o Windows.extension/memfrob.o
AOBJS=   main.o $(LIBOBJS)
BOBJS=   main.o blowfish.o $(LIBOBJS)
CSRC=    $(DISTOBJS:.o=.c) fdata.c
DISTCSRC=$(DISTOBJS:.o=.c)
DEPSRC=  $(CSRC) 

# Headerfiles which should be added to the distribution

HSRC=  array.h defs.h file.h functions.h gkommandos.h globals.h kommandos.h \
       options.h protos.h xbasic.h window.h vtypes.h ptypes.h bytecode.h \
       framebuffer.h


DIST= README INSTALL COPYING doc/man-pages/*.1 ACKNOWLEGEMENTS \
      AUTHORS doc/HISTORY RELEASE_NOTES doc/X11-Basic-manual.txt \
      doc/editors/*  $(HSRC) $(CSRC) \
      config.h.in Makefile.in configure config.guess configure.in \
        x11basic.spec \
        bitmaps/* \
        examples/compiler/xbc.bas.in \
        examples/compiler/inline.bas \
        examples/compiler/bas2x11basic.bas \
        examples/compiler/gui2bas.bas \
        examples/compiler/c-demo.c \
	examples/tests/* \
	examples/graphics/* 

BINDIST=README INSTALL COPYING doc/man-pages/*.1 ACKNOWLEGEMENTS \
      AUTHORS doc/HISTORY RELEASE_NOTES doc/X11-Basic-manual.txt \
      doc/editors/* xbasic xbc bas2x11basic xbvm \
      examples/compiler/xbc.bas.in \
      examples/compiler/inline.bas \
      examples/compiler/bas2x11basic.bas \
      examples/compiler/gui2bas.bas \
      examples/compiler/c-demo.c \
      examples/tests/* \
      examples/graphics/* 


DIST2=$(DISTOBJS:.o=.c)

DIR=X11Basic-@version@
DIR2=X11Basic-src-@version@
DIR3=X11Basic-bin-@version@
TINEDIR=tinexbasic-@version@
TINEDIST=$(DIST) doc/tine-xbasic.html examples2/DESY/*
DOOCSDIR=doocsxbasic-@version@
DOOCSDIST=$(DIST) src/doocs-wrapper.cc doc/doocs-xbasic.html \
                  doc/tine-xbasic.html examples2/DESY/*

LINKFLAGS =
WINLINKFLAGS =

LIBS =  @libs@ @xtra@ @X_EXTRA_LIBS@
WINLIBS = -lm  -lgdi32 -lkernel32 -luser32 -lole32 -luuid -lwsock32 
TINEWINLIBS = -lm -lgdi32 -lkernel32 -luser32 -lole32 -luuid -lwsock32

all :    configure Makefile xbasic xbc bas2x11basic      

configure : configure.in
	autoconf
Makefile : Makefile.in
	./configure --prefix=/usr
 
#.c.o:
#	$(CC) -c $(CFLAGS) -o $@ $<
.cc.o:
	g++ -c $(INC) -o $@ $<
mathematics.c:	mathemat_dummy.c
	test -e mathematics.c || (echo "mathematics.c is not installed. using dummy..." ; ln -s $< $@ )
xbasic.fft : $(AOBJS) 
	$(CC) $(OPT) $(LINKFLAGS) -o $@ $(AOBJS) $(LIBS) $(XLIBS)
	strip $@
fft :  xbasic.fft
	
xbasic.blow : $(BOBJS) 
	$(CC) $(OPT) $(LINKFLAGS) -o $@ $(BOBJS) $(LIBS) $(XLIBS)
	strip $@
blow : 	xbasic.blow

xbasic.vga : $(DISTOBJS) 
	$(CC) $(OPT) -DUSE_VGA $(LINKFLAGS) -o $@ $(DISTOBJS) \
		$(LIBS) $(VGA_LIBS)
	strip $@
vga :  xbasic.vga
xbasic.framebuffer : $(DISTOBJS) 
	$(CC) $(OPT) -DFRAMEBUFFER $(LINKFLAGS) -o $@ $(DISTOBJS) \
		$(LIBS) 
	strip $@
framebuffer :  xbasic.framebuffer

xbasic.static : x11basic.a main.o
	$(CC) $(OPT) $(LINKFLAGS) -o $@ main.o x11basic.a $(LIBS) $(XLIBS)
	strip $@

static : xbasic.static	
xbasic.staticreadline : x11basic.a main.o
	$(CC) $(OPT) $(LINKFLAGS) -o $@ main.o x11basic.a\
		/usr/lib/libreadline.a -ldl -lm -lncurses -lX11  $(XLIBS)
	strip $@
	
tinexbasic.rs : $(OBJS) $(AOBJS) 
	$(CC) -DTINE $(OPT) $(LINKFLAGS) -o $@ $(AOBJS)  \
		 /usr/lib/libreadline.a /usr/lib/libtine.a -ldl -lm -lncurses -lX11  $(XLIBS)
	strip $@
psydo : psydo.o lib
	$(CC) $(OPT) -L. $(LINKFLAGS) -o a.out psydo.o  \
		$(LIBS)-lx11basic $(XLIBS)
psydostatic : psydo.o x11basic.a
	$(CC) $(OPT) -L. $(LINKFLAGS) -o a.out psydo.o x11basic.a \
		$(LIBS) $(XLIBS)
windows: x11basic.lib xbasic.exe
xbasic.exe: x11basic.lib
	$(WINCC) -DWINDOWS -c main.c
	$(WINCC) -DWINDOWS $(OPT) $(WINLINKFLAGS) -o xbasic.exe main.o x11basic.lib \
		$(WINLIBS)
	strip xbasic.exe
	rm -f X11-Basic-@version@.zip
	
	zip -j -D -K -o X11-Basic-@version@.zip Windows-Installer/setup.exe xbasic.exe \
	Windows-Installer/readme.txt Windows-Installer/demo.bas \
	Windows-Installer/x11basic.ico Windows-Installer/x11bver.txt \
	Windows-Installer/X11-Basic.pdf Windows-Installer/bas.ico

examples: dist
	cd .. ; zip -r  src/X11-Basic-examples-@version@.zip examples2/
examples2: myzip
	cd .. ; tar chf  src/X11-Basic-examples-@version@.tar examples2/
	rm -f X11-Basic-examples-@version@.tar.myz
	myzip -c "X11-Basic example files (c) Markus Hoffmann" \
	                   X11-Basic-examples-@version@.tar 


tineexe: $(OBJS) main.o mathematics.o
	$(WINCC) -DTINE -DWINDOWS -c $(DIST2)
	$(WINCC) -DTINE -DWINDOWS $(OPT) $(WINLINKFLAGS) -o tinexbasic.exe $(DISTOBJS) \
		 Windows.extension/fnmatch.o  Windows.extension/memfrob.o rpclib.lib $(TINEWINLIBS)
tinexbasic.dyn : $(OBJS) main.o mathematics.o
	$(CC) -DTINE  $(LINKFLAGS) -o $@ $(AOBJS) \
		$(LIBS)  -ltine $(XLIBS)
	strip $@
tinexbasic : $(OBJS) main.o mathematics.o
	$(CC) -DTINE $(OPT) $(LINKFLAGS) -o $@ $(AOBJS) \
		$(LIBS)  /usr/lib/libtine.a $(XLIBS)
	strip $@
doocsxbasic.dyn : $(OBJS) main.o mathematics.o doocs-wrapper.o
	$(CC) -DTINE -DDOOCS  $(LINKFLAGS) -o $@ $(AOBJS) doocs-wrapper.o \
		$(LIBS)$(XLIBS) -ltine -lDOOCSclient -lDOOCSserver -lpthread
	strip $@
doocsxbasic : $(OBJS) main.o mathematics.o doocs-wrapper.o
	g++ -DTINE -DDOOCS $(OPT) $(LINKFLAGS) -o $@ $(AOBJS) \
	$(LIBS) /usr/lib/libtine.a /usr/lib/libDOOCSclient.a \
	/usr/lib/libDOOCSserver.a doocs-wrapper.o $(XLIBS) -lpthread
	strip $@


csxbasic : $(OBJS) 
	$(CC) -DCONTROL $(OPT) $(LINKFLAGS) -o $@ $(AOBJS) $(LIBS) $(XLIBS)
	strip $@
lib:	libx11basic.so x11basic.a
libx11basic.so: libx11basic.so.$(LIBNO)
	ln -s -f $< libx11basic.so.1
	ln -s -f libx11basic.so.1 libx11basic.so
libx11basic.so.$(LIBNO) : $(LIBOBJS)
	$(CC) -fPIC -shared -Wl,-soname,$@ -o $@ $(LIBOBJS)
	strip $@
winlib : x11basic.lib
	$(WINCC) -shared -o libx11basic.dll x11basic.lib

libtinex11basic.so : $(LIBOBJS)
	$(CC) $(OPT) $(LINKFLAGS) -shared -o $@ $(LIBOBJS)

x11basic.a : $(LIBOBJS)
	 ar -ru $@ $(LIBOBJS) 

x11basic.lib : $(DIST2) mathematics.c
	$(WINCC) -DWINDOWS -c $(DIST2)
	$(WINCC) -DWINDOWS -c mathematics.c
	i586-mingw32msvc-ar -ru $@ $(WINLIBOBJS) 

tinex11basic.a : $(LIBOBJS)
	 ar -ru $@ $(LIBOBJS)  

xbasic : libx11basic.so main.o
	$(CC) -L. $(LINKFLAGS) -o $@ main.o $(LIBS) -lx11basic $(XLIBS)
	strip $@
	
xbc : xbasic libx11basic.so
	LD_LIBRARY_PATH=. ./xbasic examples/compiler/xbc.bas --dynamic -o $@
	strip $@
bas2x11basic : xbc
	LD_LIBRARY_PATH=. ./xbc examples/compiler/bas2x11basic.bas --dynamic -o $@
	strip $@
myzip : xbc
	./xbc ../examples2/utils/myzip.bas --dynamic -o myzip
	./xbc ../examples2/utils/myunzip.bas --dynamic -o myunzip
	strip myzip
	strip myunzip
bytecode : bytecode.h bytecode.c virtual-machine.o
	gcc -o $@ bytecode.c virtual-machine.o -lx11basic -lm -L /usr/X11/lib/ -lX11 -lreadline	
bytecodestatic : bytecode.h bytecode.c virtual-machine.o x11basic.a
	gcc -o bytecode bytecode.c virtual-machine.o x11basic.a -lm -L /usr/X11/lib/ -lX11 -lreadline	
xbvm : bytecode.h xbvm.c virtual-machine.o bytecode.h
	gcc -o $@ xbvm.c virtual-machine.o -lx11basic -lm -L /usr/X11/lib/ -lX11 -lreadline	
xbvmstatic : bytecode.h xbvm.c virtual-machine.o bytecode.h x11basic.a
	gcc -o xbvm xbvm.c virtual-machine.o  x11basic.a -lm -L /usr/X11/lib/ -lX11 -lreadline	
install : xbasic libx11basic.so x11basic.a xbvm bytecode xbc bas2x11basic
	install -s -m 755 xbasic $(BINDIR)/
	install -m 755 libx11basic.so.$(LIBNO) $(LIBDIR)/
	ln -s -f $(LIBDIR)/libx11basic.so.$(LIBNO) $(LIBDIR)/libx11basic.so.1
	ln -s -f $(LIBDIR)/libx11basic.so.1 $(LIBDIR)/libx11basic.so
	install -m 644 x11basic.a $(LIBDIR)/
	install -m 644 doc/man-pages/x11basic.1 $(MANDIR)/man1/x11basic.1
	install -m 644 doc/man-pages/x11basic.1 $(MANDIR)/man1/xbasic.1
	install -s -m 755 xbc $(BINDIR)/
	install -s -m 755 xbvm $(BINDIR)/
	install -s -m 755 bytecode $(BINDIR)/
	install -s -m 755 bas2x11basic $(BINDIR)/
	install doc/man-pages/xbc.1 $(MANDIR)/man1/
	install doc/man-pages/xbbc.1 $(MANDIR)/man1/
	install doc/man-pages/xbvm.1 $(MANDIR)/man1/
	install doc/man-pages/bas2x11basic.1 $(MANDIR)/man1/
uninstall :
	rm -f $(LIBDIR)/libx11basic.so*
	rm -f $(LIBDIR)/x11basic.a
	rm -f $(BINDIR)/xbasic 
	rm -f $(BINDIR)/xbc 
	rm -f $(BINDIR)/xbvm 
	rm -f $(BINDIR)/bytecode 
	rm -f $(BINDIR)/bas2x11basic 
	rm -f $(MANDIR)/man1/xbasic.1
	rm -f $(MANDIR)/man1/x11basic.1 $(MANDIR)/man1/xbc.1 $(MANDIR)/man1/xbbc.1 $(MANDIR)/man1/xbvm.1
	rm -f $(MANDIR)/man1/bas2x11basic.1
clean :
	rm -f *.o a.out b.b \
	backup-*.tgz

distclean : clean
	rm -f Makefile config.cache config.status config.log xbasic xbc xbvm \
	X11-Basic-examples-@version@.zip bytecode xbasic.static \
	tinexbasic doocsxbasic xbasic.exe xbasic.dyn xbasic.staticreadline \
	myzip myunzip bas2x11basic libx11basic.so* x11basic.lib
	rm -rf autom4te.cache

dist :	$(DIST2)
	rm -rf /tmp/$(DIR)
	mkdir /tmp/$(DIR)
	(tar cf - $(DIST))|(cd /tmp/$(DIR); tar xpf -)
	(cd /tmp; tar cf - $(DIR)|gzip -9 > $(DIR).tar.gz)
	mv /tmp/$(DIR).tar.gz .
bindist : $(DIR3).zip

tinedist : $(DIST2)
	rm -rf /tmp/$(TINEDIR)
	mkdir /tmp/$(TINEDIR)
	(cd ..; tar cf - $(TINEDIST))|(cd /tmp/$(TINEDIR); tar xpf -)
	(cd /tmp; tar cf - $(TINEDIR)|gzip -9 > $(TINEDIR).tar.gz)
doocsdist : $(DIST2)
	rm -rf /tmp/$(DOOCSDIR)
	mkdir /tmp/$(DOOCSDIR)
	(cd ..; tar cf - $(DOOCSDIST))|(cd /tmp/$(DOOCSDIR); tar xpf -)
	(cd /tmp; tar cf - $(DOOCSDIR)|gzip -9 > $(DOOCSDIR).tar.gz)
rpm :	$(DIR).tar.gz x11basic.spec
	cp $(DIR).tar.gz /usr/src/packages/SOURCES/
#	rpm -ba --clean x11basic.spec
	rpmbuild -ba --clean x11basic.spec
deb :	$(BINDIST)
	sudo checkinstall -D --pkgname x11basic --pkgversion @version@ --arch i368 \
	--maintainer kollo@users.sourceforge.net --requires libreadline5 --backup \
	--pkggroup Interpreters --provides libx11basic --provides xbasic
tinerpm : $(TINEDIR).tar.gz tinexbasic.spec
	cp $(TINEDIR).tar.gz /usr/src/packages/SOURCES/
	rpmbuild -ba --clean tinexbasic.spec
doocsrpm : $(DOOCSDIR).tar.gz doocsxbasic.spec
	cp $(DOOCSDIR).tar.gz /usr/src/packages/SOURCES/
	rpmbuild -ba --clean doocsxbasic.spec
$(DIR3).zip : $(BINDIST)
	rm -rf /tmp/$(DIR3)
	mkdir /tmp/$(DIR3)
	mkdir /tmp/$(DIR3)/bin
	mkdir /tmp/$(DIR3)/man
	rsync -a README /tmp/$(DIR3)/
	rsync -a INSTALL /tmp/$(DIR3)/
	rsync -a RELEASE_NOTES /tmp/$(DIR3)/
	rsync -a xbasic /tmp/$(DIR3)/bin/
	rsync -a xbc /tmp/$(DIR3)/bin/
	rsync -a doc/man-pages/x11basic.1 /tmp/$(DIR3)/man/xbasic.1
	rsync -a doc/man-pages/x11basic.1 /tmp/$(DIR3)/man/
	(cd /tmp ; zip -r $(DIR3).zip $(DIR3))
	mv /tmp/$(DIR3).zip .	

# create DSL package (for Damn Small Linux MyDSL)	
dslpackage : xbasic.staticreadline
	(cd /dev/shm; mkdir -p home/dsl/.xtdesktop)
	convert Windows-Installer/x11basic.ico /dev/shm/home/dsl/.xtdesktop/x11basic.png
	echo "table Icon" > /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "  Type: Program" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "  Caption: X11Basic" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "  Command: aterm -e /opt/X11Basic-@version@/xbasic" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "  Icon: .xtdesktop/x11basic.png" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "  X: 405" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "  Y: 25" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	echo "end" >> /dev/shm/home/dsl/.xtdesktop/x11basic.lnk
	(cd /dev/shm; mkdir -p opt/X11Basic-@version@)
	cp xbasic.staticreadline /dev/shm/opt/X11Basic-@version@/xbasic
	(cd /dev/shm; tar czf X11Basic.tar.gz home/dsl/.xtdesktop/x11basic* opt/X11Basic-@version@)
	mv /dev/shm/X11Basic.tar.gz .
	(md5sum X11Basic.tar.gz > X11Basic.tar.gz.md5.txt )
check :	xbasic
	./xbasic -e version
depend : $(DEPSRC) 
	cp Makefile Makefile.bak
	chmod +w Makefile
	makedepend $(INC) $(DEF) $(DEPSRC) 
#	sed -n '/^# DO NOT DELETE/,$$p' < Makefile > Makefile.tmp
#	sed -n '1,/^# DO NOT DELETE/p' < Makefile > Makefile.new
#	tail +2 Makefile.tmp|\
#	sed 's/^\([A-Za-z0-9_]*\)\.o:/\1.o \1.ln:/g'>>Makefile.new
#	rm -f Makefile.tmp
#	mv Makefile.new Makefile

# DO NOT DELETE THIS LINE -- make depend depends on it.
